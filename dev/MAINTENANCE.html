<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>NA • vroom</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css"><script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet"><script src="pkgdown.js"></script><meta property="og:title" content="NA"><meta property="og:image" content="https://vroom.r-lib.org/logo.png"><meta name="robots" content="noindex"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-title-body">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">vroom</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.5.7.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="articles/vroom.html">Get started</a>
</li>
<li>
  <a href="articles/benchmarks.html">Benchmarks</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/01/vroom-1-1-0/" class="external-link">Version 1.1.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/05/vroom-1-0-0/" class="external-link">Version 1.0.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="news/index.html">Change log</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/r-lib/vroom/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>NA</h1>
    </div>


<div class="section level2">
<h2 id="current-state">Current state<a class="anchor" aria-label="anchor" href="#current-state"></a></h2>
<p>My talk at UseR 2019 gives a good overview of the goals and high level design of the package (<a href="https://www.youtube.com/watch?v=RA9AjqZXxMU&amp;t=10s" class="external-link uri">https://www.youtube.com/watch?v=RA9AjqZXxMU&amp;t=10s</a>)</p>
<p>Some of the code in vroom has grown gnarly over time as more and more edge cases have to be handled.</p>
<p>Particularly nasty bits are <code>col_spec_standardise()</code> and the code around <code>ingex_region()</code>, which can be fiddly with off by one errors.</p>
<p>It could probably stand to be re-factored and possibly simplified, if this is attempted the test cases should contain most of the known edge cases. The test coverage is fortunately decent.</p>
<p>Particular points that tend to crop up is there are different code paths for the following things - reading from normal files or connections - line endings (‘’, ‘, or’’) - files ending with a trailing newline or not. - Use of ALTREP or not</p>
<p>The test helper <code>test_vroom()</code> automatically tests the content with normal files and connections and with ALTREP on or off, but does not do any tests for line endings or trailing newlines.</p>
<p>Files without a trailing newline are automatically detected and always sent down the code that reads from a connection.</p>
<p>The only code path that is multi-threaded is normal files, connections are read asynchronously and written to a temporary file, which is then read as normal.</p>
<div class="section level3">
<h3 id="debugging">Debugging<a class="anchor" aria-label="anchor" href="#debugging"></a></h3>
<p>To compile with logging enabled you need to set <code>-DVROOM_LOG</code> in your <code>~/R/Makevars</code> and if you want to control the logging level you can set <code>-DSPDLOG_ACTIVE_LEVEL=SPDLOG_LEVEL_DEBUG</code>. You also need to create the <code>logs</code> directory for the logs to be written to. They will write a <code>logs/index.idx</code> and a <code>logs/index_connection.idx</code> file respectively. The file is appended to, not rewritten, so you would need to delete it if you want a new file after a run. There is also <code>-DVROOM_USE_CONNECTIONS_API</code> to use the CRAN forbidden connections API directly, but the performance difference is generally the same, so it isn’t really needed.</p>
</div>
</div>
<div class="section level2">
<h2 id="known-outstanding-issues">Known outstanding issues<a class="anchor" aria-label="anchor" href="#known-outstanding-issues"></a></h2>
<p>Currently the line numbers in <code><a href="reference/problems.html">problems()</a></code> don’t take into account skipped or commented lines, as we don’t keep track of how many of those we have seen. This would not be entirely trivial to do, as we would need to keep track of the locations of the skipped or commented lines in each chunk, so we could fix them up when assembling the problems data frame. It is not clear to me that this trade off is worth the effort. On the other hand reporting incorrect line numbers is also not very good.</p>
<p><a href="https://github.com/r-lib/vroom/issues/295" class="external-link uri">https://github.com/r-lib/vroom/issues/295</a> tracks this issue</p>
</div>
<div class="section level2">
<h2 id="future-directions">Future directions<a class="anchor" aria-label="anchor" href="#future-directions"></a></h2>
<p>In general it is not clear to me how much time and effort should continue to go into this in the future. Should we consider using arrow as our primary way to read in CSV files rather than relying on maintaining this codebase?</p>
<p>The lazy reading is interesting approach in theory, but it is not clear to me how many people it helps in practice. It also is effective for R primarily because of how comparatively slow R is at constructing strings, due to its reliance on the global string pool.</p>
<div class="section level3">
<h3 id="memory-mapped-index">Memory mapped index<a class="anchor" aria-label="anchor" href="#memory-mapped-index"></a></h3>
<p><a href="https://github.com/r-lib/vroom/compare/vroom-mmap-index?expand=1" class="external-link">vroom-mmap-index</a> has some experimental code for storing the index in a mmap file instead of in memory. This seemed to work well with limited testing, actually being a bit faster in initial testing then the current approach, and would allow you to handle bigger files. It would also allow you to potentially save the index once and re-use it.</p>
<p>The potential challenges are where to store the index by default, the API for how to store it, and the exact incantation needed to grow the index dynamically if needed, as we won’t know what size we need until we are done parsing.</p>
<p><a href="https://github.com/r-lib/vroom/issues/51#issue-414823372" class="external-link uri">https://github.com/r-lib/vroom/issues/51#issue-414823372</a> tracks this issue.</p>
</div>
<div class="section level3">
<h3 id="using-simd-code-for-the-indexing">Using SIMD code for the indexing<a class="anchor" aria-label="anchor" href="#using-simd-code-for-the-indexing"></a></h3>
<p><a href="https://github.com/jimhester/simdcsv" class="external-link">simdcsv</a> is an experiment with writing a CSV parser that uses SIMD approaches similar to <a href="https://github.com/simdjson/simdjson" class="external-link">simdjson</a> with some speculative parsing ideas from another paper to figure out if you are in a quoted block or not when doing multiple threads.</p>
<p>Benchmarks indicate this approach can be ~2x as fast as the current parser or so.</p>
<p>You would still then have to parse the data afterwards, it is possible there are approaches that could make this faster than the current implementations as well.</p>
</div>
</div>
<div class="section level2">
<h2 id="alternative-handling-of-files-without-trailing-newlines">Alternative handling of files without trailing newlines<a class="anchor" aria-label="anchor" href="#alternative-handling-of-files-without-trailing-newlines"></a></h2>
<p>There is a Stack overflow thread which suggests that if you mmap a file beyond the size the mmap is guaranteed to pad the remainder with 0’s. If this is true we could always do this and in that way handle the case when a file doesn’t end with a newline, which would simplify the implementation for these files, and allow us to use multi-threads to read them.</p>
<p>However we would have to investigate if this behavior is actually true across platforms or not.</p>
<p>strcspn requires the data must end with a NUL, so if we cannot guarantee that this approach won’t work.</p>
<p><a href="https://github.com/r-lib/vroom/issues/357" class="external-link uri">https://github.com/r-lib/vroom/issues/357</a> tracks this issue</p>
</div>


  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by <a href="https://jimhester.com" class="external-link">Jim Hester</a>, <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, Jennifer Bryan, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.0.</p>
</div>

      </footer></div>

  


  

  </body></html>

